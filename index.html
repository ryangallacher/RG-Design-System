<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 Emissions Table</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="controls">
            <button id="toggle-all-btn" class="toggle-all-btn" type="button" aria-expanded="true" onclick="toggleAllRows()">Collapse all</button>
            <div class="segmented" role="tablist" aria-label="Period">
                <button class="segmented-item" data-value="annual" aria-pressed="true" onclick="setPeriod('annual')">Annual</button>
                <button class="segmented-item" data-value="monthly" aria-pressed="false" onclick="setPeriod('monthly')">Monthly</button>
            </div>
        </div>
        <div class="table-wrapper">
            <!-- Desktop Table -->
            <div class="desktop-table">
                <table role="table" aria-label="CO2 Emissions Estimates">
                    <thead>
                        <tr>
                            <th>Emissions Category</th>
                            <th class="text-right">Estimated CO<sub>2</sub>E</th>
                            <th class="text-right">% of Total</th>
                            <th>Distribution</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Content will be generated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards -->
            <div class="mobile-cards" id="mobile-cards">
                <!-- Content will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const data = {
            upstream: {
                title: 'Upstream Emissions Estimate',
                total: 1553,
                percentage: 34,
                color: 'bar-teal',
                children: [
                    { name: 'Employee Hardware', amount: 1142, percentage: 25 },
                    { name: 'Upstream Emissions Estimate', amount: 302, percentage: 7 },
                    { name: 'Networking and Infrastructure Hardware', amount: 108, percentage: 2 }
                ]
            },
            direct: {
                title: 'Direct Emissions Estimate',
                total: 2981,
                percentage: 65,
                color: 'bar-red',
                children: [
                    { name: 'Employee Devices', amount: 540, percentage: 12 },
                    { name: 'Servers and Storage', amount: 2182, percentage: 47 },
                    { name: 'Networking and Infrastructure', amount: 258, percentage: 6 }
                ]
            },
            indirect: {
                title: 'Indirect Emissions Estimate',
                total: 68,
                percentage: 1,
                color: 'bar-orange',
                children: [
                    { name: 'Cloud Services', amount: 52, percentage: 1 },
                    { name: 'SaaS', amount: 16, percentage: '<1' }
                ]
            },
            downstream: {
                title: 'Downstream Emissions Estimate',
                total: 17,
                percentage: '<1',
                color: 'bar-gray',
                children: [
                    { name: 'Customer Devices', amount: 7, percentage: '<1' },
                    { name: 'Network Data Transfer', amount: 11, percentage: '<1' }
                ]
            }
        };

        const expandedRows = Object.keys(data).reduce((acc, key) => { acc[key] = true; return acc; }, {});

        function createBar(percentage, color) {
            const width = typeof percentage === 'number' ? percentage : 1;
            return `
                <div class="bar-container">
                    <div class="bar ${color}" style="width: ${width}%"></div>
                </div>
            `;
        }

        function toggleRow(key) {
            expandedRows[key] = !expandedRows[key];
            renderTable();
            renderMobileCards();
        }

        function toggleAllRows() {
            const allExpanded = Object.values(expandedRows).every(Boolean);
            Object.keys(expandedRows).forEach(k => expandedRows[k] = !allExpanded);
            renderTable();
            renderMobileCards();
        }

        function updateToggleAllButton() {
            const btn = document.getElementById('toggle-all-btn');
            if (!btn) return;
            const allExpanded = Object.values(expandedRows).every(Boolean);
            btn.textContent = allExpanded ? 'Collapse all' : 'Expand all';
            btn.setAttribute('aria-expanded', String(allExpanded));
        }

        // Period segmented control (Annual / Monthly)
        let selectedPeriod = 'annual';
        function setPeriod(value) {
            selectedPeriod = value;
            document.querySelectorAll('.segmented .segmented-item').forEach(btn => {
                const isActive = btn.getAttribute('data-value') === value;
                btn.setAttribute('aria-pressed', String(isActive));
            });
            // Future: use `selectedPeriod` to adjust data rendering (e.g., monthly breakdown)
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            let html = '';

            Object.entries(data).forEach(([key, value]) => {
                const isExpanded = expandedRows[key];
                const chevronClass = isExpanded ? 'chevron expanded' : 'chevron';
                
                html += `
                    <tr class="parent-row" onclick="toggleRow('${key}')">
                        <td>
                            <div class="category-name">
                                <svg class="${chevronClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                                <span class="category-title">${value.title}</span>
                            </div>
                        </td>
                        <td class="text-right">${value.total} kg</td>
                        <td class="text-right">${value.percentage}%</td>
                        <td>${createBar(value.percentage, value.color)}</td>
                    </tr>
                `;

                if (isExpanded) {
                    value.children.forEach(child => {
                        html += `
                            <tr class="child-row">
                                <td class="child-cell">${child.name}</td>
                                <td class="text-right small">${child.amount} kg</td>
                                <td class="text-right small">${child.percentage}%</td>
                                <td>${createBar(typeof child.percentage === 'number' ? child.percentage : 1, value.color)}</td>
                            </tr>
                        `;
                    });
                }
            });

            html += `
                <tr class="total-row">
                    <td>Total Emissions Estimate</td>
                    <td class="text-right">4619 kg</td>
                    <td class="text-right">100%</td>
                    <td>${createBar(100, 'bar-gray')}</td>
                </tr>
            `;

            tbody.innerHTML = html;
            updateToggleAllButton();
        }

        function renderMobileCards() {
            const container = document.getElementById('mobile-cards');
            let html = '';

            Object.entries(data).forEach(([key, value]) => {
                const isExpanded = expandedRows[key];
                const chevronClass = isExpanded ? 'chevron expanded' : 'chevron';

                html += `
                    <div class="card">
                        <div class="card-header" onclick="toggleRow('${key}')">
                            <svg class="${chevronClass}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                            <h3>${value.title}</h3>
                        </div>
                        <div class="card-body">
                            <div class="card-row">
                                <span class="card-label">Estimated CO<sub>2</sub>E:</span>
                                <span class="card-value">${value.total} kg</span>
                            </div>
                            <div class="card-row">
                                <span class="card-label">% of Total:</span>
                                <span class="card-value">${value.percentage}%</span>
                            </div>
                            <div>
                                <span class="card-chart-label">Distribution:</span>
                                ${createBar(value.percentage, value.color)}
                            </div>
                        </div>
                        ${isExpanded && value.children.length > 0 ? `
                            <div class="card-children">
                                ${value.children.map(child => `
                                    <div class="card-child">
                                        <div class="card-child-name">${child.name}</div>
                                        <div class="card-row">
                                            <span class="card-label">Amount:</span>
                                            <span class="card-value">${child.amount} kg</span>
                                        </div>
                                        <div class="card-row">
                                            <span class="card-label">Percentage:</span>
                                            <span class="card-value">${child.percentage}%</span>
                                        </div>
                                        <div>
                                            ${createBar(typeof child.percentage === 'number' ? child.percentage : 1, value.color)}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `
                <div class="card total-card">
                    <div class="card-header">
                        <h3>Total Emissions Estimate</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-row">
                            <span class="card-label">Total CO<sub>2</sub>E:</span>
                            <span class="card-value">4619 kg</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Percentage:</span>
                            <span class="card-value">100%</span>
                        </div>
                        <div>
                            ${createBar(100, 'bar-gray')}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            updateToggleAllButton();
        }

        // Initial render
        renderTable();
        renderMobileCards();
        setPeriod(selectedPeriod);
    </script>
</body>
</html>